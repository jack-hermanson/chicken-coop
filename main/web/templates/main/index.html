{% extends "base.html" %}

{% from "macros/card.html" import simple_card, card_body, card_header, card_footer %}
{% from "macros/pagination.html" import pagination %}
{% from "macros/form.html" import form_group %}

{% set title = "Shifts" %}
{% set active_route = "main" %}

{% block body %}
    <div class="row mb-3">
        <div class="col-12">
            <p class="lead mb-0">Every day has two shiftsâ€”one for the morning and one for the afternoon/evening.</p>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            {% for shift_instance in next_shift_instances %}
                {% call simple_card(class="mb-4") %}
                    {{ card_header(shift_instance.due_date.strftime("%A, %b %e") + ": " + shift_instance.shift.time_of_day|time_of_day_str) }}

                    {% call card_body(class="py-3") %}
                        {% if todays_date == shift_instance.due_date.date() %}
                            Due today!
                        {% endif %}
                        <p class="mb-0">This shift instance has {% if not shift_instance.completed_timestamp %}
                            NOT{% endif %} been completed</p>
                        <div id="shift-instance-form-container-{{ shift_instance.shift_instance_id }}" class="d-none">
                            <form>
                                {{ next_shift_instance_forms[loop.index0].csrf_token() }}
                                <div class="d-flex mb-3">
                                    {{ form_group(
                                                    next_shift_instance_forms[loop.index0],
                                                    "completed_timestamp",
                                                    required=True,
                                                    render_kw={"class": "form-control-sm form-control"},
                                                    class="me-3"
                                                ) }}
                                    {{ form_group(next_shift_instance_forms[loop.index0], "completed_by", required=True, render_kw={"class": "form-control-sm form-control"}) }}
                                    <div class="mt-auto">
                                        {{ next_shift_instance_forms[loop.index0].submit(class="btn btn-sm btn-success mt-auto ms-3") }}
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success"
                                    onclick="toggleShiftInstanceForm({{ shift_instance.shift_instance_id }})">Click me
                            </button>
                        </div>
                    {% endcall %}
                    {% call card_footer() %}
                        <div class="d-flex">
                            <div class="ms-auto">
                                <p class="mb-0">Test</p>
                            </div>
                        </div>
                    {% endcall %}
                {% endcall %}
            {% endfor %}
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <h4>Previous Shifts</h4>
        </div>
    </div>

    {#  Previous Shift Instances  #}
    <div class="row" id="previous-shift-instances">
        <div class="col-12">
            <ul class="list-group">
                {% for previous_shift_instance in previous_shift_instances.items %}
                    <li class="list-group-item d-block">
                        <h6>{{ previous_shift_instance.due_date.strftime("%A, %b %e") }}: {{ previous_shift_instance.shift.time_of_day|time_of_day_str }}</h6>
                        <p class="mb-0">
                            {% if previous_shift_instance.completed_timestamp %}
                                Completed by {{ previous_shift_instance.completed_by }} at
                                {{ previous_shift_instance.completed_timestamp }}.
                            {% else %}
                                Not completed.
                            {% endif %}
                        </p>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-12 d-flex justify-content-center">
            <div>
                {{ pagination(
                            endpoint="main.index",
                            pagination_model=previous_shift_instances,
                            suffix="#previous-shift-instances") }}
            </div>
        </div>
    </div>
{% endblock body %}

{% block scripts %}
    <script defer src="{{ url_for('static', filename='scripts/shift-instance-date.js') }}"></script>
{% endblock %}